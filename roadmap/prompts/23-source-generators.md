# Source Generators

**Prioridade:** P3
**Esforco:** A (Alto)
**Pilar:** DX
**Gerado em:** 2025-12-13

## Contexto

Atualmente o ZapJobs usa reflection em runtime para descobrir e registrar jobs. Isso funciona bem mas tem custos:
- Startup mais lento em aplicacoes grandes
- Maior uso de memoria
- Potenciais problemas com AOT/trimming

TickerQ usa source generators para descoberta compile-time, resultando em zero reflection.

## Objetivo

Implementar source generators para descoberta automatica de jobs em tempo de compilacao, gerando codigo de registro otimizado.

## Requisitos

### Funcionais
- [ ] Generator detecta classes que implementam `IJob<T>`
- [ ] Gera metodo de extensao `AddDiscoveredJobs()` automaticamente
- [ ] Suporta atributos para configuracao: `[Job("id")]`, `[Queue("name")]`
- [ ] Diagnosticos de compilacao para erros comuns
- [ ] Compativel com registro manual existente

### Nao-Funcionais
- [ ] Performance: Startup 50%+ mais rapido em cenarios com muitos jobs
- [ ] Compatibilidade: .NET 8+, trimming-safe, AOT-compatible
- [ ] Developer Experience: Erros claros, intellisense funcionando

## Arquivos Relevantes

```
src/
├── ZapJobs.Generators/                # NOVO PROJETO
│   ├── ZapJobs.Generators.csproj
│   ├── JobDiscoveryGenerator.cs      # Source generator principal
│   ├── JobSyntaxReceiver.cs          # Detecta candidatos
│   ├── JobMetadata.cs                # Modelo de metadados
│   └── DiagnosticDescriptors.cs      # Erros de compilacao
│
├── ZapJobs.Core/
│   ├── Attributes/
│   │   └── JobAttribute.cs           # [Job("id", Queue = "default")]
│   │   └── QueueAttribute.cs         # [Queue("name")]
│   └── Registration/
│       └── IJobRegistration.cs       # Interface gerada

src/ZapJobs/
└── ServiceCollectionExtensions.cs    # AddDiscoveredJobs()
```

## Implementacao Sugerida

### Passo 1: Criar Projeto de Generators

```xml
<!-- ZapJobs.Generators.csproj -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <EnforceExtendedAnalyzerRules>true</EnforceExtendedAnalyzerRules>
    <IsRoslynComponent>true</IsRoslynComponent>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" Version="3.3.4" />
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="4.8.0" />
  </ItemGroup>
</Project>
```

### Passo 2: Atributos de Configuracao

```csharp
// JobAttribute.cs
[AttributeUsage(AttributeTargets.Class)]
public class JobAttribute : Attribute
{
    public string JobTypeId { get; }
    public string? Queue { get; set; }
    public int MaxRetries { get; set; } = 3;
    public int TimeoutMinutes { get; set; } = 60;

    public JobAttribute(string jobTypeId)
    {
        JobTypeId = jobTypeId;
    }
}

// Uso
[Job("send-email", Queue = "notifications", MaxRetries = 5)]
public class SendEmailJob : IJob<SendEmailInput>
{
    // ...
}
```

### Passo 3: Source Generator

```csharp
[Generator]
public class JobDiscoveryGenerator : IIncrementalGenerator
{
    public void Initialize(IncrementalGeneratorInitializationContext context)
    {
        var jobClasses = context.SyntaxProvider
            .ForAttributeWithMetadataName(
                "ZapJobs.Core.Attributes.JobAttribute",
                predicate: (node, _) => node is ClassDeclarationSyntax,
                transform: GetJobMetadata)
            .Where(m => m is not null);

        context.RegisterSourceOutput(jobClasses.Collect(), GenerateRegistration);
    }

    private void GenerateRegistration(
        SourceProductionContext context,
        ImmutableArray<JobMetadata?> jobs)
    {
        var source = $$"""
            // <auto-generated/>
            namespace ZapJobs.Generated
            {
                public static class DiscoveredJobsExtensions
                {
                    public static IZapJobsBuilder AddDiscoveredJobs(
                        this IZapJobsBuilder builder)
                    {
                        {{string.Join("\n            ", jobs.Select(GenerateRegistrationLine))}}
                        return builder;
                    }
                }
            }
            """;

        context.AddSource("DiscoveredJobs.g.cs", source);
    }
}
```

### Passo 4: Uso Final

```csharp
// Antes (manual)
services.AddZapJobs(options => { ... })
    .AddJob<SendEmailJob>()
    .AddJob<ProcessOrderJob>()
    .AddJob<SyncDataJob>();

// Depois (gerado)
services.AddZapJobs(options => { ... })
    .AddDiscoveredJobs(); // Registra todos automaticamente
```

### Passo 5: Diagnosticos

```csharp
// DiagnosticDescriptors.cs
public static class Diagnostics
{
    public static readonly DiagnosticDescriptor MissingInterface = new(
        id: "ZAPJOB001",
        title: "Job must implement IJob<T>",
        messageFormat: "Class '{0}' has [Job] attribute but doesn't implement IJob<T>",
        category: "ZapJobs",
        DiagnosticSeverity.Error,
        isEnabledByDefault: true);

    public static readonly DiagnosticDescriptor DuplicateJobId = new(
        id: "ZAPJOB002",
        title: "Duplicate Job ID",
        messageFormat: "Job ID '{0}' is used by multiple classes",
        category: "ZapJobs",
        DiagnosticSeverity.Error,
        isEnabledByDefault: true);
}
```

## Criterios de Aceite

- [ ] Source generator compila e produz codigo valido
- [ ] Jobs com `[Job]` sao descobertos automaticamente
- [ ] Configuracoes do atributo sao respeitadas (queue, retries, etc)
- [ ] Erros de compilacao claros para jobs mal configurados
- [ ] Startup time reduzido vs reflection (benchmark)
- [ ] Compativel com trimming e AOT
- [ ] Documentacao de migracao para usuarios existentes

## Checklist Pre-Commit

- [ ] Projeto ZapJobs.Generators criado
- [ ] Source generator funcionando
- [ ] Atributos definidos em ZapJobs.Core
- [ ] Testes de generator (snapshot tests)
- [ ] Benchmark comparativo
- [ ] Exemplo de uso na documentacao
- [ ] CLAUDE.md atualizado
- [ ] Atualizar roadmap (marcar como concluido)
- [ ] Mover este prompt para `roadmap/archive/`

## Referencias

- [TickerQ Source Generators](https://tickerq.net/comparison/comparison-other-libraries.html)
- [Roslyn Source Generators Cookbook](https://github.com/dotnet/roslyn/blob/main/docs/features/source-generators.cookbook.md)
- [Andrew Lock - Source Generators Series](https://andrewlock.net/series/creating-a-source-generator/)
